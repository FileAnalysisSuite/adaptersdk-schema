/**
 * Copyright 2022-2023 Micro Focus or one of its affiliates.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
using System;
using System.CodeDom;
using System.CodeDom.Compiler;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Reflection;
using System.Text;
using System.Text.Json.Nodes;
using System.Text.RegularExpressions;
using Microsoft.CSharp;

namespace MicroFocus.FAS.AdapterSdkSchema
{
    public class SchemaObjectBuilderSourceCreator
    {
        private static readonly string BUILDER_CLASS_NAME = "AdapterSdkSchemaObjectBuilder";
        private static readonly Dictionary<string, Type> PROPERTY_TYPES_LOOKUP = new() {
            { "STRING", typeof(string) },
            { "FULLTEXT", typeof(string) },
            { "LONG", typeof(long) },
            { "DOUBLE", typeof(double) },
            { "INTEGER", typeof(int) },
            { "BOOLEAN", typeof(bool) },
            { "DATETIME", typeof(DateTime) }
        };
        private static readonly Dictionary<string, string> PROPERTY_NULLABLE_TYPES_LOOKUP = new() {
            { "STRING", typeof(string).Name },
            { "FULLTEXT", typeof(string).Name },
            { "LONG", "long?" },
            { "DOUBLE", "double?" },
            { "INTEGER", "int?" },
            { "BOOLEAN", "bool?" },
            { "DATETIME", "DateTime" }
        };
        private static readonly Dictionary<string, string> PROPERTY_TYPES_METHOD_LOOKUP = new() {
            { "STRING", "String" },
            { "FULLTEXT", "String" },
            { "LONG", "Long" },
            { "DOUBLE", "Double" },
            { "INTEGER", "Integer" },
            { "BOOLEAN", "Boolean" },
            { "DATETIME", "Instant" }
        };

        private static JsonNode typesNode;

        private SchemaObjectBuilderSourceCreator()
        {
        }

        public static string Create()
        {
            Debug.WriteLine("Start creating schema object builder code...");
            JsonNode schemaJson = SchemaGeneratorHelper.ParseSchemaDefinition();
            typesNode = schemaJson["types"].AsObject();
            CodeCompileUnit schemaCompileUnit = new();

            // Create namespace
            CodeNamespace schemaNamespace = new(SchemaGeneratorHelper.NAMESPACE_NAME);

            schemaNamespace.Imports.Add(new CodeNamespaceImport("System"));
            schemaNamespace.Imports.Add(new CodeNamespaceImport("System.Collections.Generic"));
            schemaNamespace.Imports.Add(new CodeNamespaceImport("System.Linq"));

            schemaCompileUnit.Namespaces.Add(schemaNamespace);
            schemaNamespace.Comments.Add(
                new CodeCommentStatement("This file is auto-generated by SchemaGenerator"));

            var schemaClassBuilder = new SchemaObjectBuilderSourceCreator().CreateSchemaObjectBuilderSource(
                BUILDER_CLASS_NAME, false, null, null, schemaJson["fields"].AsObject(), new String[0], "", true, true);
            schemaNamespace.Types.Add(schemaClassBuilder);

            using StringWriter writer = new();
            CSharpCodeProvider provider = new();
            provider.GenerateCodeFromCompileUnit(schemaCompileUnit, writer, new CodeGeneratorOptions());

            var schemaObjectBuilderSource = writer.ToString();

            Debug.WriteLine("Schema source : " + schemaObjectBuilderSource);
            return schemaObjectBuilderSource;
        }

        private CodeTypeDeclaration CreateSchemaObjectBuilderSource(
            string builderClassName,
            bool isEntityTypeObjectBuilderClass,
            CodeMemberMethod buildFunctionBuilder,
            CodeMemberMethod validateFunctionBuilder,
            JsonNode schemaNode,
            string[] path,
            string parentFieldName,
            bool isParentFieldFlattened,
            bool isMainClass
        )
        {
            Debug.WriteLine("Define the schema object builder class: " + builderClassName);
            // Define the schema object builder class
            var typeAttrs = isMainClass
                ? TypeAttributes.Public | TypeAttributes.Sealed | TypeAttributes.Class
                : TypeAttributes.Public | TypeAttributes.Class;

            CodeTypeDeclaration schemaClassBuilder = new(builderClassName)
            {
                TypeAttributes = typeAttrs
            };

            AddSchemaObjectBuilderFieldAndCtor(schemaClassBuilder);

            // Create a 'validate' method
            CodeMemberMethod parentValidator = validateFunctionBuilder;

            validateFunctionBuilder = new()
            {
                    Name = "Validate",
                    Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            // Add property setters
            AddPropertySetters(
                schemaClassBuilder,
                isEntityTypeObjectBuilderClass,
                buildFunctionBuilder,
                validateFunctionBuilder,
                schemaNode,
                path,
                parentFieldName,
                isParentFieldFlattened
            );

            schemaClassBuilder.Members.Add(validateFunctionBuilder);

            if (parentValidator != null)
            {
                validateFunctionBuilder = parentValidator;
            }

            return schemaClassBuilder;
        }

        private static void AddSchemaObjectBuilderFieldAndCtor(CodeTypeDeclaration schemaClassBuilder)
        {
            Debug.WriteLine("AddSchemaObjectBuilderFieldAndCtor...");
            CodeMemberField field = new()
            {
                Name = "_schemaObjectBuilder",
                Attributes = MemberAttributes.Private,
                Type = new CodeTypeReference("readonly ISchemaObjectBuilder")
            };

            schemaClassBuilder.Members.Add(field);

            CodeParameterDeclarationExpression ctorParam = new(new CodeTypeReference("ISchemaObjectBuilder"), "schemaObjectBuilder");
            CodeConstructor constructor = new ()
            {
                Attributes = MemberAttributes.Public
            };
            constructor.Parameters.Add(ctorParam);
            CodeAssignStatement ctorBodyFieldInit = new()
            {
                Left = new CodeFieldReferenceExpression(new CodeThisReferenceExpression(), "_schemaObjectBuilder"),
                Right = new CodeSnippetExpression("schemaObjectBuilder")
            };
            constructor.Statements.Add(ctorBodyFieldInit);

            schemaClassBuilder.Members.Add(constructor);
        }
    
        private void AddPropertySetters(
            CodeTypeDeclaration objectBuilderClassBuilder,
            bool isEntityTypeObjectBuilderClass,
            CodeMemberMethod buildFunctionBuilder,
            CodeMemberMethod validateFunctionBuilder,
            JsonNode entityDef,
            string[] path,
            string parentFieldName,
            bool isParentFieldFlattened
        )
        {
            Debug.WriteLine("AddPropertySetters for: " + entityDef);
            IEnumerator<KeyValuePair<string, JsonNode>> propertyIterator = entityDef.AsObject().GetEnumerator();

            bool isSubfield = path.Length > 0;

            while (propertyIterator.MoveNext())
            {
                KeyValuePair<string, JsonNode> property = propertyIterator.Current;
                JsonNode fieldAttributes = property.Value;
                string propertyName = property.Key;

                string fieldType = fieldAttributes["type"].GetValue<string>();

                int endOfArrayDimension = fieldType.LastIndexOf('[');

                string fieldTypeValue = endOfArrayDimension > 0
                    ? fieldType.Substring(0, endOfArrayDimension)
                    : fieldType;

                int numberOfDimensions = endOfArrayDimension > 0
                    ? Regex.Matches(fieldType, Regex.Escape("[]")).Count
                    : 0;

                bool isFlattened = fieldAttributes["objectEncoding"] != null
                    && fieldAttributes["objectEncoding"].GetValue<string>().Equals("flattened");

                bool isFieldMultiValued = fieldType.EndsWith("[]");

                bool isFieldMandatory = fieldAttributes["mandatory"] != null
                    && Boolean.Parse(fieldAttributes["mandatory"].GetValue<string>());

                string fieldFunctionName = SchemaGeneratorHelper.ToProperCase(propertyName);

                if (isFieldMandatory && !isEntityTypeObjectBuilderClass)
                {
                    // This is a mandatory field of the main Schema
                    // Add instance variable for checking if field is set
                    string validatorFieldName = SchemaGeneratorHelper.ToValidatorFieldName(propertyName);
                    AddValidateField(objectBuilderClassBuilder, validatorFieldName);

                    // Update validate function
                    CheckFieldsInValidateMethod(validateFunctionBuilder, null, propertyName, validatorFieldName);
                }

                if (!SchemaGeneratorHelper.PROPERTY_TYPES.Contains(fieldType))
                {
                    // Entity/Object type field
                    AddEntityTypePropertySetters(
                        objectBuilderClassBuilder,
                        isEntityTypeObjectBuilderClass,
                        buildFunctionBuilder,
                        validateFunctionBuilder,
                        fieldFunctionName,
                        fieldType,
                        fieldTypeValue,
                        isFieldMandatory,
                        isFieldMultiValued,
                        numberOfDimensions,
                        isSubfield,
                        path,
                        propertyName,
                        parentFieldName,
                        isFlattened,
                        isParentFieldFlattened
                    );
                }
                else
                {
                    // non entity type field
                    AddNonEntityTypePropertySetterMethods(
                        objectBuilderClassBuilder,
                        buildFunctionBuilder,
                        validateFunctionBuilder,
                        fieldFunctionName,
                        fieldTypeValue,
                        isFieldMandatory,
                        isFieldMultiValued,
                        isSubfield,
                        propertyName,
                        parentFieldName,
                        isParentFieldFlattened
                    );
                }
            }
        }

        private void AddEntityTypePropertySetters(
            CodeTypeDeclaration objectBuilderClassBuilder,
            bool isEntityTypeObjectBuilderClass,
            CodeMemberMethod buildFunctionBuilder,
            CodeMemberMethod validateFunctionBuilder,
            string fieldFunctionName,
            string fieldType,
            string fieldTypeValue,
            bool isFieldMandatory,
            bool isFieldMultiValued,
            int numberOfDimensions,
            bool isSubfield,
            string[] path,
            string propertyName,
            string parentFieldName,
            bool isFlattened,
            bool isParentFieldFlattened
        )
        {
            string objBuilderClassName = fieldFunctionName + "ObjectBuilder";
            Debug.WriteLine("AddEntityTypePropertySetters for: " + propertyName + " : " + objBuilderClassName);
            int endOfTypeName = fieldType.IndexOf('[');
            string refTypeName = endOfTypeName > 0
                        ? fieldType.Substring(0, endOfTypeName)
                        : fieldType;
            JsonNode subentityDef = typesNode[refTypeName];

            string[] newPath = SchemaGeneratorHelper.AddExtraElement(path, objBuilderClassName);
            string fullName = isSubfield ? parentFieldName + "." + propertyName : propertyName;

            string builderTypeName = "Action<" + objBuilderClassName + ">";

            string internalVarName = SchemaGeneratorHelper.ToFieldNameCase(propertyName);
            string internalBuilderVarName = internalVarName + "Builder";

            // Add clear field method body
            CodeMemberMethod clearFieldMethodBuilder = new()
            { 
                Name = "Clear" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            // Add setters, clear, and list object builder classes
            // "ocr[][]" // every additional dimension would need a ListBuilder
            string validatorSubFieldName = SchemaGeneratorHelper.ToValidatorFieldName(internalBuilderVarName);
            if (numberOfDimensions > 1)
            {
                AddMultiDimensionalEntityTypeProperty(
                    objectBuilderClassBuilder,
                    isEntityTypeObjectBuilderClass,
                    objBuilderClassName,
                    internalBuilderVarName,
                    fieldFunctionName,
                    fullName,
                    internalVarName,
                    numberOfDimensions,
                    isFlattened,
                    isFieldMandatory,
                    isSubfield,
                    validatorSubFieldName
                );
                // Add 'clear' field method body
                clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(
                        new StringBuilder("_schemaObjectBuilder.ClearField(")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(fullName)
                        .Append(")")
                        .ToString()
                    )
                );
            }
            else
            {
                // Single dimension field
                if (isFlattened)
                {
                    // Sub entity is flattened
                    // Add entity type field 'set' function with 'Builder' param
                    AddBuilderParamSetterMethod(
                        objectBuilderClassBuilder,
                        isEntityTypeObjectBuilderClass,
                        fieldFunctionName,
                        fullName,
                        builderTypeName,
                        objBuilderClassName,
                        internalBuilderVarName,
                        isFlattened,
                        isFieldMandatory,
                        isSubfield,
                        validatorSubFieldName);

                    // Add 'set' function with 'List' param
                    AddBuilderListParamSetterMethod(
                        objectBuilderClassBuilder,
                        isEntityTypeObjectBuilderClass,
                        fieldFunctionName,
                        fullName,
                        builderTypeName,
                        objBuilderClassName,
                        internalBuilderVarName,
                        isFlattened,
                        isFieldMandatory,
                        isSubfield,
                        validatorSubFieldName);

                    // Add 'clear' field method body
                    clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(
                         new StringBuilder("_schemaObjectBuilder.ClearField(")
                            .Append(SchemaGeneratorHelper.CLASS_NAME)
                            .Append(".")
                            .Append(fullName)
                            .Append(")")
                            .ToString()
                        )
                    );

                    if (isFieldMandatory && isSubfield)
                    {
                        // Add instance variable for checking if subField is set
                        AddValidateField(objectBuilderClassBuilder, validatorSubFieldName);

                        // Note that mandatory field is cleared
                        MarkPropertyIsCleared(clearFieldMethodBuilder, validatorSubFieldName);

                        // add field to validate method
                        CheckFieldsInValidateMethod(
                            validateFunctionBuilder,
                            parentFieldName,
                            propertyName,
                            validatorSubFieldName);
                    }
                }
                else
                {
                    // Sub entity is json encoded
                    if (isParentFieldFlattened)
                    {
                        // parent is flattened, but this sub entity is not
                        buildFunctionBuilder = new()
                        {
                            Name = "Build",
                            Attributes = MemberAttributes.Assembly
                        };

                        CodeParameterDeclarationExpression buildMethodParam = new(new CodeTypeReference("IJsonBuilder"), "jsonBuilder");
                        buildFunctionBuilder.Parameters.Add(buildMethodParam);
                        buildFunctionBuilder.Statements.Add(new CodeSnippetExpression("jsonBuilder.WriteStartObject()"));

                        // Add entity type property 'set' function 'Builder' param
                        AddBuilderParamSetterMethod(
                            objectBuilderClassBuilder,
                            isEntityTypeObjectBuilderClass,
                            fieldFunctionName,
                            fullName,
                            builderTypeName,
                            objBuilderClassName,
                            internalBuilderVarName,
                            isFlattened,
                            isFieldMandatory,
                            isSubfield,
                            validatorSubFieldName);

                        // Add entity type property 'set' function with 'List' param
                        AddBuilderListParamSetterMethod(
                            objectBuilderClassBuilder,
                            isEntityTypeObjectBuilderClass,
                            fieldFunctionName,
                            fullName,
                            builderTypeName,
                            objBuilderClassName,
                            internalBuilderVarName,
                            isFlattened,
                            isFieldMandatory,
                            isSubfield,
                            validatorSubFieldName);

                        // Add 'clear' field method body
                        clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(
                                new StringBuilder("_schemaObjectBuilder.ClearField(")
                                .Append(SchemaGeneratorHelper.CLASS_NAME)
                                .Append(".")
                                .Append(fullName)
                                .Append(")")
                                .ToString()
                            )
                        );
                    }
                    else
                    {
                        // parent is json encoded, this sub entity is also json encoded

                        var intFieldType = isFieldMultiValued
                            ? new CodeTypeReference("List<" + objBuilderClassName + ">")
                            : new CodeTypeReference(objBuilderClassName);

                        CodeMemberField entityTypeField = new()
                        {
                            Name = internalVarName,
                            Attributes = MemberAttributes.Private,
                            Type = intFieldType
                        };

                        objectBuilderClassBuilder.Members.Add(entityTypeField);

                        // Add entity type property 'set' function 'Builder' param
                        AddNestedObjectBuilderParamSetterMethod(
                            objectBuilderClassBuilder,
                            fieldFunctionName,
                            internalVarName,
                            builderTypeName,
                            objBuilderClassName,
                            internalBuilderVarName,
                            isFlattened);

                        // Add entity type property 'set' function with 'List' param
                        AddNestedObjectBuilderListParamSetterMethod(
                            objectBuilderClassBuilder,
                            fieldFunctionName,
                            internalVarName,
                            builderTypeName,
                            objBuilderClassName,
                            internalBuilderVarName,
                            isFlattened);

                        // Add 'clear' field method body
                        clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(internalVarName + " = null"));
                    }

                    // Write Json field
                    WriteJsonFieldsInBuildMethod(
                        buildFunctionBuilder,
                        fieldTypeValue,
                        isFieldMandatory,
                        isFieldMultiValued,
                        parentFieldName,
                        propertyName,
                        internalVarName,
                        objBuilderClassName);
                }
            }

            // Add an object builder class for entity type property (recursively creates SchemaObjectBuilder)
            AddEntityTypeObjectBuilderClass(
                objectBuilderClassBuilder,
                objBuilderClassName,
                buildFunctionBuilder,
                validateFunctionBuilder,
                subentityDef,
                newPath,
                fullName,
                isFlattened);

            if (isFieldMandatory && !isEntityTypeObjectBuilderClass)
            {
                // Note that mandatory entity-type field of main schema is cleared
                MarkPropertyIsCleared(clearFieldMethodBuilder, SchemaGeneratorHelper.ToValidatorFieldName(propertyName));
            }
            // Add clear field method
            objectBuilderClassBuilder.Members.Add(clearFieldMethodBuilder);
        }

        private void AddNestedObjectBuilderParamSetterMethod(
           CodeTypeDeclaration objectBuilderClassBuilder,
           string fieldFunctionName,
           string internalVarName,
           string builderTypeName,
           string objBuilderClassName,
           string internalBuilderVarName,
           bool isFlattened
        )
        {
            Debug.WriteLine("AddNestedObjectBuilderParamSetterMethod for: " + internalVarName);
            CodeParameterDeclarationExpression builderParamName = new(builderTypeName, "director");
            CodeMemberMethod setBuilderFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setBuilderFieldValue.Parameters.Add(builderParamName);

            if (isFlattened)
            {
                setBuilderFieldValue.Statements.Add(
                    new CodeSnippetExpression(objBuilderClassName + " "+ internalBuilderVarName + " = new "+ objBuilderClassName + "(this._schemaObjectBuilder)"));
            }
            else
            {
                setBuilderFieldValue.Statements.Add(
                    new CodeSnippetExpression(objBuilderClassName + " "+ internalBuilderVarName + " = new "+ objBuilderClassName + "()"));
            }
            setBuilderFieldValue.Statements.Add(new CodeSnippetExpression("director.Invoke(" + internalBuilderVarName + ")"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetExpression(internalVarName + " = new List<" + objBuilderClassName  + ">()"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetExpression(internalVarName + ".Add("+ internalBuilderVarName + ")"));

            objectBuilderClassBuilder.Members.Add(setBuilderFieldValue);
        }

        private void AddNestedObjectBuilderListParamSetterMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string fieldFunctionName,
            string internalVarName,
            string builderTypeName,
            string objBuilderClassName,
            string internalBuilderVarName,
            bool isFlattened)
        {
            Debug.WriteLine("AddNestedObjectBuilderListParamSetterMethod for: " + internalVarName);
            CodeParameterDeclarationExpression streamParamFieldName = new(new CodeTypeReference("List<" + builderTypeName + ">"), "directors");
            CodeMemberMethod setStreamFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setStreamFieldValue.Parameters.Add(streamParamFieldName);

            setStreamFieldValue.Statements.Add(
                    //new CodeSnippetStatement(internalVarName + " = directors.Select<Action<" + objBuilderClassName + ">, Action<ISchemaObjectBuilder>>(director => {"));
                    new CodeSnippetStatement(internalVarName + " = directors.Select(director => {"));
            if (isFlattened)
            {
                setStreamFieldValue.Statements.Add(
                    new CodeSnippetStatement(objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "(this._schemaObjectBuilder);"));
            }
            else
            {
                setStreamFieldValue.Statements.Add(
                    new CodeSnippetStatement(objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "();"));
            }

            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("  director.Invoke(" + internalBuilderVarName + ");"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("  return " + internalBuilderVarName + ";"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("}).ToList();"));

            objectBuilderClassBuilder.Members.Add(setStreamFieldValue);
        }

        private void AddEntityTypeObjectBuilderClass(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string objBuilderClassName,
            CodeMemberMethod buildFunctionBuilder,
            CodeMemberMethod validateFunctionBuilder,
            JsonNode subentityDef,
            string[] newPath,
            string fullName,
            bool isFlattened
        )
        {
            Debug.WriteLine("AddEntityTypeObjectBuilderClass for: " + objBuilderClassName);
            if (isFlattened)
            {
                CodeTypeDeclaration fieldObjectBuilderClassBuilder
                    = CreateSchemaObjectBuilderSource(
                        objBuilderClassName,
                        true,
                        buildFunctionBuilder,
                        validateFunctionBuilder,
                        subentityDef,
                        newPath,
                        fullName,
                        true,
                        true);

                objectBuilderClassBuilder.Members.Add(fieldObjectBuilderClassBuilder);
            }
            else
            {
                // This class will have instance variables for each property and a 'build' function to write json values
                CodeTypeDeclaration fieldObjectBuilderClassBuilder = new(objBuilderClassName)
                {
                    TypeAttributes = TypeAttributes.Public | TypeAttributes.Class
                };
                CodeConstructor defaultCtor = new()
                {
                    Attributes = MemberAttributes.Assembly
                };
                fieldObjectBuilderClassBuilder.Members.Add(defaultCtor);

                // Create a 'build' method
                CodeMemberMethod parentBuilder = buildFunctionBuilder;
                buildFunctionBuilder = new()
                {
                    Name = "Build",
                    Attributes = MemberAttributes.Assembly
                };
                CodeParameterDeclarationExpression buildMethodParam = new(new CodeTypeReference("IJsonBuilder"), "jsonBuilder");
                buildFunctionBuilder.Parameters.Add(buildMethodParam);
                buildFunctionBuilder.Statements.Add(new CodeSnippetExpression("jsonBuilder.WriteStartObject()"));

                // Add all the sub-fields of this entity type property
                AddPropertySetters(
                    fieldObjectBuilderClassBuilder,
                    true,
                    buildFunctionBuilder,
                    validateFunctionBuilder,
                    subentityDef,
                    newPath,
                    fullName,
                    false);

                buildFunctionBuilder.Statements.Add(new CodeSnippetExpression("jsonBuilder.WriteEndObject()"));
                fieldObjectBuilderClassBuilder.Members.Add(buildFunctionBuilder);
                if (parentBuilder != null) {
                    buildFunctionBuilder = parentBuilder;
                }
                objectBuilderClassBuilder.Members.Add(fieldObjectBuilderClassBuilder);
            }
        }

        private void AddMultiDimensionalEntityTypeProperty(
            CodeTypeDeclaration objectBuilderClassBuilder,
            bool isEntityTypeObjectBuilderClass,
            string objBuilderClassName,
            string internalBuilderVarName,
            string fieldFunctionName,
            string fullName,
            string internalVarName,
            int numberOfDimensions,
            bool isFlattened,
            bool isFieldMandatory,
            bool isSubField,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("AddMultiDimensionalEntityTypeProperty for: " + fullName);
            // Multi-dimensional field
            // Add a list object builder class for property
            string suffix = "ObjectBuilder";
            string listName = "";
            for (int i = 0; i < numberOfDimensions - 1; i++)
            {
                listName += "List";
                AddListBuilderClass(
                    objectBuilderClassBuilder,
                    objBuilderClassName,
                    fieldFunctionName + listName + suffix,
                    internalVarName,
                    isFlattened);
            }
            string listObjBuilderClassName = fieldFunctionName + listName + suffix;
            string listBuilderTypeName = "Action<" + listObjBuilderClassName + ">";

            // Add 'set' function with 'Builder' param
            AddBuilderParamSetterMethod(
                objectBuilderClassBuilder,
                isEntityTypeObjectBuilderClass,
                fieldFunctionName,
                fullName,
                listBuilderTypeName,
                listObjBuilderClassName,
                internalBuilderVarName,
                isFlattened,
                isFieldMandatory,
                isSubField,
                validatorSubFieldName);

            // Add 'set' function with 'List' param
            AddBuilderListParamSetterMethod(
                objectBuilderClassBuilder,
                isEntityTypeObjectBuilderClass,
                fieldFunctionName,
                fullName,
                listBuilderTypeName,
                listObjBuilderClassName,
                internalBuilderVarName,
                isFlattened,
                isFieldMandatory,
                isSubField,
                validatorSubFieldName);
        }

        private void AddBuilderParamSetterMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            bool isEntityTypeObjectBuilderClass,
            string fieldFunctionName,
            string propertyName,
            string builderTypeName,
            string objBuilderClassName,
            string internalBuilderVarName,
            bool isFlattened,
            bool isFieldMandatory,
            bool isSubField,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("AddBuilderParamSetterMethod for: " + propertyName);
            CodeParameterDeclarationExpression builderParamName = new(new CodeTypeReference(builderTypeName), "director");
            CodeMemberMethod setBuilderFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setBuilderFieldValue.Parameters.Add(builderParamName);

            if (isFlattened)
            {
                SetFlattenedFieldValue(
                    setBuilderFieldValue,
                    propertyName,
                    objBuilderClassName,
                    internalBuilderVarName,
                    isFieldMandatory,
                    isSubField,
                    validatorSubFieldName);
            }
            else
            {
                SetJsonFieldValue(setBuilderFieldValue, propertyName, objBuilderClassName, internalBuilderVarName);
            }
            if (isFieldMandatory && !isEntityTypeObjectBuilderClass)
            {
                MarkPropertyIsSet(setBuilderFieldValue, SchemaGeneratorHelper.ToValidatorFieldName(propertyName));
            }
            objectBuilderClassBuilder.Members.Add(setBuilderFieldValue);

        }

        private void AddBuilderListParamSetterMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            bool isEntityTypeObjectBuilderClass,
            string fieldFunctionName,
            string propertyName,
            string builderTypeName,
            string objBuilderClassName,
            string internalBuilderVarName,
            bool isFlattened,
            bool isFieldMandatory,
            bool isSubField,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("AddBuilderListParamSetterMethod for: " + propertyName);
            CodeParameterDeclarationExpression streamParamFieldName = new(new CodeTypeReference("IEnumerable<" + builderTypeName + ">"), "directors");
            CodeMemberMethod setStreamFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setStreamFieldValue.Parameters.Add(streamParamFieldName);

            if (isFlattened) {
                SetFlattenedFieldValueStream(
                    setStreamFieldValue,
                    propertyName,
                    objBuilderClassName,
                    internalBuilderVarName,
                    isFieldMandatory,
                    isSubField,
                    validatorSubFieldName);
            }
            else
            {
                SetJsonFieldValueStream(setStreamFieldValue, propertyName, objBuilderClassName, internalBuilderVarName);
            }
            if (isFieldMandatory && !isEntityTypeObjectBuilderClass)
            {
                MarkPropertyIsSet(setStreamFieldValue, SchemaGeneratorHelper.ToValidatorFieldName(propertyName));
            }
            objectBuilderClassBuilder.Members.Add(setStreamFieldValue);
        }

        private void SetJsonFieldValue(
            CodeMemberMethod setBuilderFieldValue,
            string propertyName,
            string objBuilderClassName,
            string internalBuilderVarName
        )
        {
            Debug.WriteLine("SetJsonFieldValue for: " + propertyName);
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement(objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("director.Invoke(" + internalBuilderVarName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("_schemaObjectBuilder.SetJsonFieldValue("));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("  " + SchemaGeneratorHelper.CLASS_NAME + "." + propertyName + ",jsonBuilder => {"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("  " + internalBuilderVarName + ".Build(jsonBuilder);"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("}"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement(");"));
        }

        private void SetFlattenedFieldValue(
            CodeMemberMethod setBuilderFieldValue,
            string propertyName,
            string objBuilderClassName,
            string internalBuilderVarName,
            bool isFieldMandatory,
            bool isSubField,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("SetFlattenedFieldValue for: " + propertyName);
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("_schemaObjectBuilder.SetFlattenedFieldValue(" + SchemaGeneratorHelper.CLASS_NAME + "." + propertyName + ", sBuilder => {"));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("    " + objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "(sBuilder);"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    director.Invoke(" + internalBuilderVarName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    " + internalBuilderVarName + ".Validate();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("});"));
            if (isFieldMandatory && isSubField)
            {
                MarkPropertyIsSet(setBuilderFieldValue, validatorSubFieldName);
            }
        }

        private void SetJsonFieldValueStream(
            CodeMemberMethod setBuilderFieldValue,
            string propertyName,
            string objBuilderClassName,
            string internalBuilderVarName
        )
        {
            Debug.WriteLine("SetJsonFieldValueStream for: " + propertyName);
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("_schemaObjectBuilder.SetJsonFieldValue("));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement(SchemaGeneratorHelper.CLASS_NAME + "." + propertyName + ","));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("  directors.Select<Action<" + objBuilderClassName + ">, Action<IJsonBuilder>>(director => {"));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement(objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("director.Invoke(" + internalBuilderVarName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("  return jsonBuilder => {"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("  " + internalBuilderVarName + ".Build(jsonBuilder);"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("};"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("}));"));
        }

        private void SetFlattenedFieldValueStream(
            CodeMemberMethod setBuilderFieldValue,
            string propertyName,
            string objBuilderClassName,
            string internalBuilderVarName,
            bool isFieldMandatory,
            bool isSubField,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("SetFlattenedFieldValueStream for: " + propertyName);
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("_schemaObjectBuilder.SetFlattenedFieldValue(" + SchemaGeneratorHelper.CLASS_NAME + "." + propertyName + ","));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("    directors.Select<Action<"+ objBuilderClassName + ">, Action<ISchemaObjectBuilder>>(director => {"));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("    return sBuilder => {"));
            setBuilderFieldValue.Statements.Add(
                new CodeSnippetStatement("    " + objBuilderClassName + " " + internalBuilderVarName + " = new " + objBuilderClassName + "(sBuilder);"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    director.Invoke(" + internalBuilderVarName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    " + internalBuilderVarName + ".Validate();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    };"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("}));"));
            if (isFieldMandatory && isSubField)
            {
                MarkPropertyIsSet(setBuilderFieldValue, validatorSubFieldName);
            }
        }

        private void AddListBuilderClass(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string objBuilderClassName,
            string listObjBuilderClassName,
            string internalVarName,
            bool isFlattened
        )
        {
            Debug.WriteLine("AddListBuilderClass for: " + listObjBuilderClassName);
            CodeTypeDeclaration fieldListObjectBuilderClassBuiler = new(listObjBuilderClassName)
            {
                TypeAttributes = TypeAttributes.Public | TypeAttributes.Class
            };

            // flattened does not need 'build' function and instance/state variables
            if (isFlattened)
            {
                AddSchemaObjectBuilderFieldAndCtor(fieldListObjectBuilderClassBuiler);

                // Add 'set' function with 'Builder' param
                AddFieldListObjectBuilderBuilderParamSetterMethod(
                    fieldListObjectBuilderClassBuiler, objBuilderClassName, internalVarName);

                // Add 'set' function with 'List' param
                AddFieldListObjectBuilderListParamSetterMethod(
                    fieldListObjectBuilderClassBuiler, objBuilderClassName, internalVarName);

                // Add 'clear' field method
                AddFieldListObjectBuilderClearMethod(fieldListObjectBuilderClassBuiler);

                // Add 'validate' field method
                AddFieldListObjectBuilderValidateMethod(fieldListObjectBuilderClassBuiler);
            }
            else
            {
                // Json encoded
                CodeConstructor defaultCtor = new()
                {
                    Attributes = MemberAttributes.Assembly
                };
                fieldListObjectBuilderClassBuiler.Members.Add(defaultCtor);

                // Add instance variable for list of field object builders
                string listName = internalVarName + "Builders";

                CodeMemberField fieldObjBuilderList = new()
                {
                    Name = listName,
                    Attributes = MemberAttributes.Private,
                    Type = new CodeTypeReference("List<" + objBuilderClassName + ">")
                };

                fieldListObjectBuilderClassBuiler.Members.Add(fieldObjBuilderList);

                // Add 'set' function with 'Builder' param
                AddFieldListObjectBuilderBuilderParamSetterMethod(
                    fieldListObjectBuilderClassBuiler, objBuilderClassName, internalVarName, listName);

                // Add 'set' function with 'List' param
                AddFieldListObjectBuilderListParamSetterMethod(
                    fieldListObjectBuilderClassBuiler, objBuilderClassName, internalVarName, listName);

                // Add 'clear' field method
                AddFieldListObjectBuilderClearMethod(fieldListObjectBuilderClassBuiler, listName);

                // Add 'build' method
                AddFieldListObjectBuilderBuildMethod(fieldListObjectBuilderClassBuiler, objBuilderClassName, listName);
            }

            objectBuilderClassBuilder.Members.Add(fieldListObjectBuilderClassBuiler);
        }

        private void AddFieldListObjectBuilderBuilderParamSetterMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string objBuilderClassName,
            string fieldName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderBuilderParamSetterMethod for: " + objBuilderClassName);
            CodeParameterDeclarationExpression builderParamName = new(new CodeTypeReference("Action<" + objBuilderClassName + ">"), "director");

            string varName = fieldName + "ObjectBuilder";
            CodeMemberMethod setBuilderFieldValue = new()
            {
                Name = "Set",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            setBuilderFieldValue.Parameters.Add(builderParamName);

            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("this._schemaObjectBuilder.SetFlattenedFieldValue(null, builder => {"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    " + objBuilderClassName + " " + varName + " = new " + objBuilderClassName + "(builder);"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    director.Invoke(" + varName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("    " + varName + ".Validate();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("});"));

            listObjectBuilderClassBuiler.Members.Add(setBuilderFieldValue);
        }

        private void AddFieldListObjectBuilderListParamSetterMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string objBuilderClassName,
            string fieldName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderListParamSetterMethod for: " + objBuilderClassName);
            CodeParameterDeclarationExpression streamParamFieldName = new(
                new CodeTypeReference("IEnumerable<Action<" + objBuilderClassName + ">>"), "directors");

            string varName = fieldName + "ObjectBuilder";
            CodeMemberMethod setStreamFieldValue = new()
            {
                Name = "Set",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            setStreamFieldValue.Parameters.Add(streamParamFieldName);


            setStreamFieldValue.Statements.Add(
                new CodeSnippetStatement(
                    "this._schemaObjectBuilder.SetFlattenedFieldValue(null, directors.Select<Action<"
                    + objBuilderClassName 
                    + ">, Action<ISchemaObjectBuilder>>(director => builder => {"));
            setStreamFieldValue.Statements.Add
                (new CodeSnippetStatement("    " + objBuilderClassName + " "+ varName + " = new "+ objBuilderClassName + "(builder);"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("    director.Invoke(" + varName + ");"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("    " + varName + ".Validate();"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("}));"));

            listObjectBuilderClassBuiler.Members.Add(setStreamFieldValue);
        }

        private void AddFieldListObjectBuilderClearMethod(CodeTypeDeclaration listObjectBuilderClassBuiler)
        {
            Debug.WriteLine("AddFieldListObjectBuilderClearMethod...");
            CodeMemberMethod clearFieldMethod = new()
            {
                Name = "Clear",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            clearFieldMethod.Statements.Add(new CodeSnippetExpression("this._schemaObjectBuilder.ClearField(null)"));
            listObjectBuilderClassBuiler.Members.Add(clearFieldMethod);
        }

        private void AddFieldListObjectBuilderValidateMethod(CodeTypeDeclaration listObjectBuilderClassBuiler)
        {
            Debug.WriteLine("AddFieldListObjectBuilderValidateMethod...");
            CodeMemberMethod validateMethod = new()
            {
                Name = "Validate",
                Attributes = MemberAttributes.Assembly
            };

            listObjectBuilderClassBuiler.Members.Add(validateMethod);
        }

        private void AddFieldListObjectBuilderBuilderParamSetterMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string objBuilderClassName,
            string fieldName,
            string listName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderBuilderParamSetterMethod..." + objBuilderClassName);
            CodeParameterDeclarationExpression builderParamName = new(new CodeTypeReference("Action<" + objBuilderClassName + ">"), "director");

            string varName = fieldName + "ObjectBuilder";
            CodeMemberMethod setBuilderFieldValue = new()
            {
                Name = "Set",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            setBuilderFieldValue.Parameters.Add(builderParamName);

            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement(objBuilderClassName + " " + varName + " = new " + objBuilderClassName + "();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement("director.Invoke("+ varName + ");"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement(listName + " = new List<" + objBuilderClassName + ">();"));
            setBuilderFieldValue.Statements.Add(new CodeSnippetStatement(listName + ".Add("+ varName + ");"));

            listObjectBuilderClassBuiler.Members.Add(setBuilderFieldValue);
        }

        private void AddFieldListObjectBuilderListParamSetterMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string objBuilderClassName,
            string fieldName,
            string listName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderListParamSetterMethod..." + objBuilderClassName);
            CodeParameterDeclarationExpression streamParamFieldName = new(
                new CodeTypeReference("IEnumerable<Action<" + objBuilderClassName + ">>"), "directors");

            string varName = fieldName + "ObjectBuilder";
            CodeMemberMethod setStreamFieldValue = new()
            {
                Name = "Set",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setStreamFieldValue.Parameters.Add(streamParamFieldName);

            //setStreamFieldValue.Statements.Add(new CodeSnippetStatement(listName + " = directors.Select<Action<" + objBuilderClassName + ">, Action<ISchemaObjectBuilder>>(director => {"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement(listName + " = directors.Select(director => {"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("  " + objBuilderClassName + " "+ varName + " = new "+ objBuilderClassName + "();"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("  director.Invoke(" + varName + ");"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("  return " + varName + ";"));
            setStreamFieldValue.Statements.Add(new CodeSnippetStatement("}).ToList();"));

            listObjectBuilderClassBuiler.Members.Add(setStreamFieldValue);
        }

        private void AddFieldListObjectBuilderClearMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string listName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderClearMethod..." + listName);
            CodeMemberMethod clearListMethod = new()
            {
                Name = "Clear",
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            clearListMethod.Statements.Add(new CodeSnippetExpression(listName + " = null"));
            listObjectBuilderClassBuiler.Members.Add(clearListMethod);
        }

        private void AddFieldListObjectBuilderBuildMethod(
            CodeTypeDeclaration listObjectBuilderClassBuiler,
            string objBuilderClassName,
            string listName
        )
        {
            Debug.WriteLine("AddFieldListObjectBuilderBuildMethod..." + listName);
            CodeMemberMethod buildFunctionBuilder = new ()
                {
                    Name = "Build",
                    Attributes = MemberAttributes.Assembly
            };
            CodeParameterDeclarationExpression buildMethodParam = new(new CodeTypeReference("IJsonBuilder"), "jsonBuilder");
            buildFunctionBuilder.Parameters.Add(buildMethodParam);

            buildFunctionBuilder.Statements.Add(new CodeSnippetStatement("jsonBuilder.WriteStartArray();"));

            CodeConditionStatement ifStatement = new()
            {
                Condition = new CodeSnippetExpression(listName + " != null")
            };
            ifStatement.TrueStatements.Add(new CodeSnippetStatement("foreach ("+ objBuilderClassName + " value in "+ listName + ")"));
            ifStatement.TrueStatements.Add(new CodeSnippetStatement("{"));
            ifStatement.TrueStatements.Add(new CodeSnippetStatement("  value.Build(jsonBuilder);"));
            ifStatement.TrueStatements.Add(new CodeSnippetStatement("}"));
            buildFunctionBuilder.Statements.Add(ifStatement);
            buildFunctionBuilder.Statements.Add(new CodeSnippetStatement("jsonBuilder.WriteEndArray();"));

            listObjectBuilderClassBuiler.Members.Add(buildFunctionBuilder);
        }

        private void AddNonEntityTypePropertySetterMethods(
            CodeTypeDeclaration objectBuilderClassBuilder,
            CodeMemberMethod buildFunctionBuilder,
            CodeMemberMethod validateFunctionBuilder,
            string fieldFunctionName,
            string fieldTypeValue,
            bool isFieldMandatory,
            bool isFieldMultiValued,
            bool isSubfield,
            string propertyName,
            string parentFieldName,
            bool isParentFieldFlattened
        )
        {
            Debug.WriteLine("AddNonEntityTypePropertySetterMethods..." + propertyName);
            Type fieldType = PROPERTY_TYPES_LOOKUP[fieldTypeValue];
            string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];
            CodeParameterDeclarationExpression paramSingleFieldValue = new(new CodeTypeReference(fieldType), "value");

            string subFieldName = SchemaGeneratorHelper.ToFieldNameCase(propertyName);
            string validatorSubFieldName = SchemaGeneratorHelper.ToValidatorFieldName(propertyName);

            // Add setter variations for multi-valued field
            if (isFieldMultiValued)
            {
                // Set 'array' value
                AddArrayParamSetterMethod(
                    objectBuilderClassBuilder,
                    fieldFunctionName,
                    propertyName,
                    subFieldName,
                    fieldTypeValue,
                    isSubfield,
                    parentFieldName,
                    isParentFieldFlattened,
                    isFieldMandatory,
                    validatorSubFieldName);

                // Set 'List' value
                AddListParamSetterMethod(
                    objectBuilderClassBuilder,
                    fieldFunctionName,
                    propertyName,
                    subFieldName,
                    fieldTypeValue,
                    isSubfield,
                    parentFieldName,
                    isParentFieldFlattened,
                    isFieldMandatory,
                    validatorSubFieldName);

                // Add 'single' value
                AddSingleValueAddMethod(
                    objectBuilderClassBuilder,
                    paramSingleFieldValue,
                    fieldFunctionName,
                    propertyName,
                    subFieldName,
                    fieldTypeValue,
                    isSubfield,
                    parentFieldName,
                    isParentFieldFlattened,
                    isFieldMandatory,
                    validatorSubFieldName);
            }

            CodeMemberMethod setSingleFieldValueMethodBuilder = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setSingleFieldValueMethodBuilder.Parameters.Add(paramSingleFieldValue);

            CodeMemberMethod clearFieldMethodBuilder = new()
            {
                Name = "Clear" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };

            if (isSubfield)
            {
                // This is a non entity type property of an entity type property
                if (isParentFieldFlattened)
                {
                    clearFieldMethodBuilder.Statements.Add(
                        new CodeSnippetExpression(
                            new StringBuilder("_schemaObjectBuilder.ClearField(")
                            .Append(SchemaGeneratorHelper.CLASS_NAME)
                            .Append(".")
                            .Append(parentFieldName)
                            .Append(".")
                            .Append(propertyName)
                            .Append(")")
                            .ToString()
                        )
                    );

                    setSingleFieldValueMethodBuilder.Statements.Add(
                        new CodeSnippetExpression(
                            new StringBuilder("_schemaObjectBuilder.Set")
                            .Append(fieldTypeMethodName)
                            .Append("FieldValue(")
                            .Append(SchemaGeneratorHelper.CLASS_NAME)
                            .Append(".")
                            .Append(parentFieldName)
                            .Append(".")
                            .Append(propertyName)
                            .Append(")")
                            .ToString()
                         )
                    );

                    if (isFieldMandatory)
                    {
                        // Add instance variable for checking if subField is set
                        AddValidateField(objectBuilderClassBuilder, validatorSubFieldName);

                        // Note that mandatory field is set
                        MarkPropertyIsSet(setSingleFieldValueMethodBuilder, validatorSubFieldName);
                        // Note that mandatory field is cleared
                        MarkPropertyIsCleared(clearFieldMethodBuilder, validatorSubFieldName);

                        // add field to validate method
                        CheckFieldsInValidateMethod(
                            validateFunctionBuilder,
                            parentFieldName,
                            propertyName,
                            validatorSubFieldName);
                    }
                }
                else
                {
                    // Add instance variable for subField
                    CodeTypeReference fldType = isFieldMultiValued
                        ? new CodeTypeReference("List<" + PROPERTY_NULLABLE_TYPES_LOOKUP[fieldTypeValue] + ">")
                        : new CodeTypeReference(PROPERTY_NULLABLE_TYPES_LOOKUP[fieldTypeValue]);
                    CodeMemberField field = new()
                    {
                        Name = subFieldName,
                        Attributes = MemberAttributes.Private,
                        Type = fldType
                    };
                    objectBuilderClassBuilder.Members.Add(field);

                    // Add 'clear' function body
                    clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(subFieldName + " = null"));

                    // write Json fields
                    WriteJsonFieldsInBuildMethod(
                        buildFunctionBuilder,
                        fieldTypeValue,
                        isFieldMandatory,
                        isFieldMultiValued,
                        parentFieldName,
                        propertyName,
                        subFieldName,
                        null);

                    // Add setters for multi-valued subfield
                    if (isFieldMultiValued)
                    {
                        // Add set single value function body
                        setSingleFieldValueMethodBuilder.Statements.Add(
                            new CodeSnippetExpression(
                                new StringBuilder("this.")
                                .Append(subFieldName)
                                .Append(" = new List<")
                                .Append(fieldType)
                                .Append(">()")
                                .ToString()
                            )
                        );
                        setSingleFieldValueMethodBuilder.Statements.Add(new CodeSnippetExpression("this." + subFieldName + ".Add(value)" ));
                    }
                    else
                    {
                        setSingleFieldValueMethodBuilder.Statements.Add(new CodeSnippetExpression("this." + subFieldName  + " = value"));
                    }
                }
            }
            else
            {
                // This is a non entity type property in the main schema
                clearFieldMethodBuilder.Statements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("_schemaObjectBuilder.ClearField(")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(propertyName)
                        .Append(")")
                        .ToString()
                    )
                );

                setSingleFieldValueMethodBuilder.Statements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("_schemaObjectBuilder.Set")
                        .Append(fieldTypeMethodName)
                        .Append("FieldValue(")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(propertyName)
                        .Append(", value)")
                        .ToString()
                    )
                );

                if (isFieldMandatory)
                {
                    string validatorFieldName = SchemaGeneratorHelper.ToValidatorFieldName(propertyName);
                    MarkPropertyIsCleared(clearFieldMethodBuilder, validatorFieldName);
                    MarkPropertyIsSet(setSingleFieldValueMethodBuilder, validatorFieldName);
                }
            }

            // Add 'single value' setter method
            objectBuilderClassBuilder.Members.Add(setSingleFieldValueMethodBuilder);

            // Add 'clear' field method
            objectBuilderClassBuilder.Members.Add(clearFieldMethodBuilder);

        }

        private void WriteJsonFieldsInBuildMethod(
            CodeMemberMethod buildFunctionBuilder,
            string fieldTypeValue,
            bool isFieldMandatory,
            bool isFieldMultiValued,
            string parentFieldName,
            string propertyName,
            string subFieldName,
            string objBuilderClassName
        )
        {
            Debug.WriteLine("WriteJsonFieldsInBuildMethod..." + propertyName + " subFieldName: " + subFieldName  + " objBuilderClassName: " + objBuilderClassName);

            CodeSnippetExpression writeFieldNameExpn = new(
                new StringBuilder("jsonBuilder.WriteFieldName(")
                .Append(SchemaGeneratorHelper.CLASS_NAME)
                .Append(".")
                .Append(parentFieldName)
                .Append(".")
                .Append(propertyName)
                .Append(".FieldName)")
                .ToString()
            );

            List<CodeSnippetStatement> writeFieldValueStatements
                = GetWriteJsonValueStatements(
                    isFieldMultiValued,
                    objBuilderClassName,
                    fieldTypeValue,
                    subFieldName
                  );

            if (isFieldMandatory)
            {
                CodeConditionStatement ifStatement = new()
                {
                    Condition = new CodeSnippetExpression(subFieldName + " == null")
                };
                ifStatement.TrueStatements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("throw new ArgumentException(\"Mandatory field '")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(parentFieldName)
                        .Append(".")
                        .Append(propertyName)
                        .Append("' is not set\")")
                        .ToString()
                    ));
                ifStatement.FalseStatements.Add(writeFieldNameExpn);
                foreach (var stmt in writeFieldValueStatements)
                {
                    ifStatement.FalseStatements.Add(stmt);
                }
                buildFunctionBuilder.Statements.Add(ifStatement);
            }
            else
            {
                var nullCheckExpression = SchemaGeneratorHelper.IsPrimitiveNullableType(fieldTypeValue)
                    ? new CodeSnippetExpression(subFieldName + ".HasValue")
                    : new CodeSnippetExpression(subFieldName + " != null");
                CodeConditionStatement ifStatement = new()
                {
                    Condition = nullCheckExpression
                };
                ifStatement.TrueStatements.Add(writeFieldNameExpn);
                foreach(var stmt in writeFieldValueStatements)
                {
                    ifStatement.TrueStatements.Add(stmt);
                }
                buildFunctionBuilder.Statements.Add(ifStatement);
            }
        }

        private List<CodeSnippetStatement> GetWriteJsonValueStatements(
            bool isFieldMultiValued,
            string objBuilderClassName,
            string fieldTypeValue,
            string subFieldName
        )
        {
            Debug.WriteLine("GetWriteJsonValueStatements..." + subFieldName);
            List<CodeSnippetStatement> statements = new();
            if (isFieldMultiValued)
            {
                // Add 'build' function body
                statements.Add(new CodeSnippetStatement("jsonBuilder.WriteStartArray();"));

                if (objBuilderClassName == null)
                {
                    string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];
                    statements.Add(new CodeSnippetStatement("foreach(" + fieldTypeMethodName + " value in " + subFieldName + ")"));
                    statements.Add(new CodeSnippetStatement("{"));
                    statements.Add(new CodeSnippetStatement("jsonBuilder.Write" + fieldTypeMethodName + "(value);"));
                }
                else
                {
                    statements.Add(new CodeSnippetStatement("foreach(" + objBuilderClassName + " value in " + subFieldName + ")"));
                    statements.Add(new CodeSnippetStatement("{"));
                    statements.Add(new CodeSnippetStatement("value.Build(jsonBuilder);"));
                }
                statements.Add(new CodeSnippetStatement("}"));

                statements.Add(new CodeSnippetStatement("jsonBuilder.WriteEndArray();"));
            }
            else
            {
                string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];
                var subFieldValue = SchemaGeneratorHelper.IsPrimitiveNullableType(fieldTypeValue)
                    ? subFieldName + ".Value"
                    : subFieldName;
                statements.Add(
                    new CodeSnippetStatement("jsonBuilder.Write" + fieldTypeMethodName + "(" + subFieldValue + ");")
                );
            }
            return statements;
        }

        private void MarkPropertyIsSet(CodeMemberMethod setFieldMethodBuilder, string validatorFieldName)
        {
            Debug.WriteLine("MarkPropertyIsSet..." + validatorFieldName);
            setFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(validatorFieldName +" = true"));
        }

        private void MarkPropertyIsCleared(CodeMemberMethod clearFieldMethodBuilder, string validatorFieldName)
        {
            Debug.WriteLine("MarkPropertyIsCleared..." + validatorFieldName);
            clearFieldMethodBuilder.Statements.Add(new CodeSnippetExpression(validatorFieldName + " = false"));
        }

        private void AddSingleValueAddMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            CodeParameterDeclarationExpression paramSingleFieldValue,
            string fieldFunctionName,
            string propertyName,
            string subFieldName,
            string fieldTypeValue,
            bool isSubfield,
            string parentFieldName,
            bool isParentFieldFlattened,
            bool isFieldMandatory,
            string validatorSubFieldName)
        {
            Debug.WriteLine("AddSingleValueAddMethod..." + propertyName);
            Type fieldType = PROPERTY_TYPES_LOOKUP[fieldTypeValue];
            string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];

            CodeMemberMethod addFieldValue = new()
            {
                Name= "Add" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            addFieldValue.Parameters.Add(paramSingleFieldValue);

            if (isSubfield)
            {
                if (isParentFieldFlattened)
                {
                    addFieldValue.Statements.Add(
                        new CodeSnippetExpression(
                            new StringBuilder("_schemaObjectBuilder.Add")
                            .Append(fieldTypeMethodName)
                            .Append("FieldValue(")
                            .Append(SchemaGeneratorHelper.CLASS_NAME)
                            .Append(".")
                            .Append(parentFieldName)
                            .Append(".")
                            .Append(propertyName)
                            .Append(", value)")
                            .ToString()
                        )
                    );
                    if (isFieldMandatory)
                    {
                        // Note mandatory field has been set
                        MarkPropertyIsSet(addFieldValue, validatorSubFieldName);
                    }
                }
                else
                {
                    CodeConditionStatement ifStatement = new()
                    {
                        Condition = new CodeSnippetExpression(subFieldName + " == null")
                    };
                    CodeAssignStatement assignmentStmt = new()
                    {
                        Left = new CodeFieldReferenceExpression(new CodeThisReferenceExpression(), subFieldName),
                        Right = new CodeSnippetExpression("new List<" + fieldType.Name + ">()")
                    };
                    ifStatement.TrueStatements.Add(assignmentStmt);

                    addFieldValue.Statements.Add(ifStatement);
                    addFieldValue.Statements.Add(
                        new CodeSnippetExpression(
                            new StringBuilder("this.")
                            .Append(subFieldName)
                            .Append(".Add(value)")
                            .ToString()
                        )
                    );
                }
            }
            else
            {
                addFieldValue.Statements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("_schemaObjectBuilder.Add")
                        .Append(fieldTypeMethodName)
                        .Append("FieldValue(")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(propertyName)
                        .Append(", value)")
                        .ToString()
                    )
                );
                if (isFieldMandatory)
                {
                    // Note mandatory field has been set
                    MarkPropertyIsSet(addFieldValue, validatorSubFieldName);
                }
            }

            objectBuilderClassBuilder.Members.Add(addFieldValue);
        }

        private void AddListParamSetterMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string fieldFunctionName,
            string propertyName,
            string subFieldName,
            string fieldTypeValue,
            bool isSubfield,
            string parentFieldName,
            bool isParentFieldFlattened,
            bool isFieldMandatory,
            string validatorSubFieldName)
        {
            Debug.WriteLine("AddListParamSetterMethod..." + propertyName);
            Type fieldType = PROPERTY_TYPES_LOOKUP[fieldTypeValue];
            string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];

            CodeParameterDeclarationExpression listParamFieldName = new(new CodeTypeReference("List<" + fieldType + ">"), "values");

            CodeMemberMethod setListFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setListFieldValue.Parameters.Add(listParamFieldName);

            if (isSubfield) {
                if(isParentFieldFlattened) {
                    setListFieldValue.Statements.Add(
                        new CodeSnippetExpression(
                            new StringBuilder("_schemaObjectBuilder.Set")
                            .Append(fieldTypeMethodName)
                            .Append("FieldValue(")
                            .Append(SchemaGeneratorHelper.CLASS_NAME)
                            .Append(".")
                            .Append(parentFieldName)
                            .Append(".")
                            .Append(propertyName)
                            .Append(", values)")
                            .ToString()
                        )
                    );
                    if (isFieldMandatory) {
                        // Note mandatory field has been set
                        MarkPropertyIsSet(setListFieldValue, validatorSubFieldName);
                    }
                }
                else
                {
                    setListFieldValue.Statements.Add(new CodeSnippetExpression("this." + subFieldName + " = values"));
                }
            }
            else
            {
                setListFieldValue.Statements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("_schemaObjectBuilder.Set")
                        .Append(fieldTypeMethodName)
                        .Append("FieldValue(")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(propertyName)
                        .Append(", values)")
                        .ToString()
                    )
                );
                if (isFieldMandatory)
                {
                    // Note mandatory field has been set
                    MarkPropertyIsSet(setListFieldValue, validatorSubFieldName);
                }
            }

            objectBuilderClassBuilder.Members.Add(setListFieldValue);
        }

        private void AddArrayParamSetterMethod(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string fieldFunctionName,
            string propertyName,
            string subFieldName,
            string fieldTypeValue,
            bool isSubfield,
            string parentFieldName,
            bool isParentFieldFlattened,
            bool isFieldMandatory,
            string validatorSubFieldName)
        {
            Debug.WriteLine("AddListParamSetterMethod...: " + propertyName);
            Type fieldType = PROPERTY_TYPES_LOOKUP[fieldTypeValue];
            string fieldTypeMethodName = PROPERTY_TYPES_METHOD_LOOKUP[fieldTypeValue];

            CodeParameterDeclarationExpression arrayParamFieldName = new(fieldType + "[]", "values");
            arrayParamFieldName.CustomAttributes.Add(new CodeAttributeDeclaration(new CodeTypeReference(typeof(ParamArrayAttribute))));

            CodeMemberMethod setArrayFieldValue = new()
            {
                Name = "Set" + fieldFunctionName,
                Attributes = MemberAttributes.Public | MemberAttributes.Final
            };
            setArrayFieldValue.Parameters.Add(arrayParamFieldName);

            if (isSubfield)
            {
                if (isParentFieldFlattened)
                {
                    setArrayFieldValue.Statements.Add(new CodeSnippetStatement(
                        "_schemaObjectBuilder.Set" + fieldTypeMethodName + "FieldValue(" + SchemaGeneratorHelper.CLASS_NAME + "."+ parentFieldName + "."+ propertyName + ", values);"));
                    if (isFieldMandatory)
                    {
                        // Note mandatory field has been set
                        MarkPropertyIsSet(setArrayFieldValue, validatorSubFieldName);
                    }
                }
                else
                {
                    setArrayFieldValue.Statements.Add(
                        new CodeSnippetStatement("this."+ subFieldName + " = values.ToList();"));
                }
            }
            else
            {
                setArrayFieldValue.Statements.Add(
                    new CodeSnippetStatement("_schemaObjectBuilder.Set" + fieldTypeMethodName + "FieldValue(" + SchemaGeneratorHelper.CLASS_NAME + "." + propertyName + ", values);"));
                if (isFieldMandatory)
                {
                    // Note mandatory field has been set
                    MarkPropertyIsSet(setArrayFieldValue, validatorSubFieldName);
                }
            }
            objectBuilderClassBuilder.Members.Add(setArrayFieldValue);
        }

        private void CheckFieldsInValidateMethod(
            CodeMemberMethod validateFunctionBuilder,
            string parentFieldName,
            string propertyName,
            string validatorSubFieldName
        )
        {
            Debug.WriteLine("CheckFieldsInValidateMethod..." + propertyName);
            CodeConditionStatement ifStatement = new()
            {
                Condition = new CodeSnippetExpression("!" + validatorSubFieldName)
            };
            if (parentFieldName == null)
            {
                ifStatement.TrueStatements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("throw new ArgumentException(\"Mandatory field '")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(propertyName)
                        .Append("' is not set\")")
                        .ToString()
                    )
                );
            }
            else
            {
                ifStatement.TrueStatements.Add(
                    new CodeSnippetExpression(
                        new StringBuilder("throw new ArgumentException(\"Mandatory field '")
                        .Append(SchemaGeneratorHelper.CLASS_NAME)
                        .Append(".")
                        .Append(parentFieldName)
                        .Append(".")
                        .Append(propertyName)
                        .Append("' is not set\")")
                        .ToString()
                    )
                );
            }
            validateFunctionBuilder.Statements.Add(ifStatement);
        }

        private void AddValidateField(
            CodeTypeDeclaration objectBuilderClassBuilder,
            string fieldNameCheck
        )
        {
            Debug.WriteLine("AddValidateField : " + fieldNameCheck);
            CodeMemberField validateField = new()
            {
                Name = fieldNameCheck,
                Attributes = MemberAttributes.Private,
                Type = new CodeTypeReference(typeof(bool))
            };
            objectBuilderClassBuilder.Members.Add(validateField);
        }
    }
}
